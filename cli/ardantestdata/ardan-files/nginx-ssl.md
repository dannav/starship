## NGINX

It's a good idea to have NGINX block urls that don't exist and are common
entry points for hackers. Inside `nginx.conf` add the return 403 to the
servers.

If using Cloud66 with SSL make sure this is in all the server blocks.

```
http {
...

  server {
  ...
      # if requesting a suspicious url extension
      # kill the connection with 444.
      location ~ \.(php|aspx?|htm)$ {
        return 444;
      }
```

or to block anything that does not start with v1 or metrics.

```
        # if does NOT start with v1 (for api) or metrics (for prometheus)
        # kill the connection with 444.
        location ~ ^/(?!(v1|metrics)) {
           return 444;
        }
```

To validate an nginx configuration.

```
nginx -c /etc/nginx/nginx.conf
```

## SSL

### Renewing

Renewing an SSL certificate. It only happens once a year so we typically
forget what we did the year before. Here are the steps.

- Login to dnsimple.com and renew the certifcate. This requires selecting an email
  at the domain like administrator@outcast.io.

  - If pinning the outcast app then there are a few special steps. You can find the original
    files here. https://drive.google.com/drive/u/0/folders/1m4RRkyemNYOUGTPz7SZlnAn8xweoTVgG
  - When renewing the certificate make sure to use the `original.csr`.
  - Outcast might have several certificates in DNSimple. Use this one https://dnsimple.com/a/15902/domains/outcast.io/certificates/45580.

- An email is sent to choosen email address directly from Comodo with a verification code. Once
  you recieve the code enter it into Comodo as mentioned in the email.

  - For outcast.io the email address is `administrator@outcast.io`, goes to Ed.
  - For ardanstudios.com the email address is `webmaster@ardanstudios.com`, goes to info@ardanstudios.com.
  - For goinggo.net the email address is `info@ardanstudios.com`.
  - For ardanlabs.com the email address is `webmaster@ardanlabs.com`, goes to Bill, Ed and John.
  - For servi.io the email address is `webmaster@servi.io`, goes to Bill, Ed and John.

- The certificates are sent via email.
  - If not using a custom CSR the private key is generated by DNSimple and must be downloaded from there. It takes
    some time before it is available in the DNSimple SSL interface.

- Update Cloud66, select the stack and select `SSL` from Add-Ins.

  - If it is a normal new\renewed certificate, you will have to copy and paste the private key, crt
    and maybe bundle.
    It can be found in DNSimple under the certificate "Install the SSL Certificate". Then select
    "NGINX" to download the files. The `pem` should be used for the SSL Certificate in Cloud66 and the
    `key` should be used for the Certificate Key.
  - If renewing a pinned SSL (like Outcast), then only the certificate will need to be updated in Cloud66.

### Match crt and key

Sometimes it might be useful to verify that the certificate and private key match. Run the commands below
and make sure the md5 hashes are the same.

```
openssl x509 -noout -modulus -in certificate.crt | openssl md5
openssl rsa -noout -modulus -in privateKey.key | openssl md5
```
